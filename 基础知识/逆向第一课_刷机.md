# 安卓逆向学习笔记

## 一、刷机基础

### 1. 驱动与工具

Windows 默认不带 Android 设备的 ADB/Fastboot 驱动，插上手机会显示"设备无法识别"。需要手动安装驱动。

#### 驱动安装方式

| 方式 | 说明 |
|------|------|
| Google USB Driver | 随 Android SDK Platform Tools 提供，通用性好 |
| 厂商官方驱动 | 小米 MiFlash、三星 Kies 等工具自带驱动 |
| Universal ADB Driver | 如 15 seconds ADB Installer，一键安装 |

#### Platform Tools

Android SDK Platform Tools 是 Google 官方提供的命令行工具包，包含两个核心工具：

- **adb** (Android Debug Bridge)：手机正常开机状态下与电脑通信
- **fastboot**：手机进入 Bootloader/Fastboot 模式时与电脑通信

下载解压后需将路径添加到系统 PATH 环境变量中：

```
设置 → 系统 → 关于 → 高级系统设置 → 环境变量 → 在 Path 中添加解压路径
```

验证连接：

```bash
adb devices
# 看到 "xxxxxxxx device" 即连接成功
```

---

### 2. 核心概念

#### Bootloader（BL）

Bootloader 是手机开机时最先运行的程序，类似电脑的 BIOS/UEFI。职责：

1. 硬件初始化
2. 验证并加载系统镜像（boot、system 等分区）

**BL 锁（Bootloader Lock）**：厂商出厂时锁定 Bootloader，确保只能启动官方签名的系统。BL 锁着时，无法刷入任何第三方镜像。

#### 为什么要解 BL 锁？

做逆向通常需要 Root 权限，而获取 Root 需要修改 boot 分区（如刷 Magisk），这要求 BL 必须解锁。

#### 线刷 vs 卡刷

| | 线刷 | 卡刷 |
|---|------|------|
| **方式** | USB 数据线连电脑，通过 fastboot 或厂商工具刷入 | 刷机包放到手机存储/SD 卡，通过 Recovery 刷入 |
| **模式** | Fastboot 模式 / Download 模式（三星用 Odin） | Recovery 模式 |
| **适用场景** | 刷官方固件、救砖、刷分区镜像 | 刷第三方 ROM、刷 Magisk zip 包 |
| **风险** | 可以救砖，相对安全 | 如果 Recovery 有问题可能失败 |

---

### 3. 不同品牌的差异

每个手机品牌的解锁流程不同：

- **小米**：需要在开发者选项绑定账号申请解锁，用官方 Mi Unlock 工具解锁，有等待期（通常7天）
- **一加/Pixel**：相对简单，`fastboot oem unlock` 或 `fastboot flashing unlock` 即可
- **华为**：早期可申请解锁码，现已关闭官方渠道
- **三星**：开启 OEM 解锁选项后，进入 Download 模式解锁

---

## 二、小米9（cepheus）刷机实战

### 设备信息

- 机型：小米9
- 代号：cepheus
- 处理器：骁龙 855（高通）
- 安卓版本：Android 11
- 系统版本：MIUI 12.5.6

---

### 第一步：安装驱动和工具

1. **安装驱动**：下载小米 MiFlash 刷机工具，安装过程中自动装好驱动
2. **安装 Platform Tools**：下载 Android SDK Platform Tools，解压到如 `C:\platform-tools`，添加到 PATH
3. **开启 USB 调试**：
   ```
   设置 → 关于手机 → 连点"MIUI版本"7次 → 开启开发者选项
   设置 → 更多设置 → 开发者选项 → 打开 USB 调试
   ```
4. **验证连接**：`adb devices` 看到设备序列号即成功

---

### 第二步：解 BL 锁（小米特有流程）

#### 2a. 绑定账号

```
设置 → 更多设置 → 开发者选项 → 设备解锁状态 → 绑定账号和设备
```

将小米账号与设备绑定，告知小米服务器要解锁此设备。

#### 2b. 等待

小米有等待期，通常 **168 小时（7天）**，有时 72 小时。这是防盗机制，无法跳过。

#### 2c. 使用 Mi Unlock 工具解锁

1. 下载小米官方 Mi Unlock Tool
2. 登录绑定的小米账号
3. 手机进入 Fastboot 模式：关机后同时按住 **电源键 + 音量下键**，出现 Fastboot 兔子图标
4. USB 连接电脑
5. 点击"解锁"

> **警告：解锁会清空所有数据，务必提前备份！**

解锁成功后每次开机会显示 "unlocked" 提示，属正常现象。

---

### 第三步：获取 Root（刷 Magisk）

#### 3a. 获取对应版本的 boot.img

确认完整版本号（类似 `V12.5.6.0.RFACNXM`）：

```
设置 → 关于手机 → MIUI版本
```

下载与当前版本**完全一致**的官方线刷包（tgz 格式），解压后提取 `boot.img`。

下载来源：
- 小米官方 ROM 下载页面
- 第三方归档网站（如 xiaomifirmwareupdater 等）

#### 3b. 使用 Magisk Patch

1. 将 `boot.img` 传到手机
2. 安装 Magisk App（从 GitHub 下载最新 APK）
3. Magisk → 安装 → 选择并修补一个文件 → 选择 `boot.img`
4. 生成 `magisk_patched-xxxxx.img`（在 Download 目录下）
5. 传回电脑：
   ```bash
   adb pull /sdcard/Download/magisk_patched-xxxxx.img C:\
   ```

#### 3c. 刷入 patched boot

```bash
adb reboot bootloader
# 等待进入 Fastboot 模式
fastboot flash boot C:\magisk_patched-xxxxx.img
fastboot reboot
```

重启后打开 Magisk App，显示版本号和"正常"即 Root 成功。

验证：

```bash
adb shell
su
whoami
# 输出 root 即成功
```

---

### 操作时间线

```
今天能做的：
  ✓ 装驱动、装 Platform Tools
  ✓ adb devices 验证连接
  ✓ 开发者选项里绑定解锁账号

等 7 天后：
  ✓ 用 Mi Unlock 解 BL 锁

解锁后当天：
  ✓ 下载对应 ROM 提取 boot.img
  ✓ Magisk patch → fastboot flash
  ✓ Root 完成
```

---

## 三、Root 后能做什么（逆向相关）

| 需求 | 为什么需要 Root |
|------|-----------------|
| Frida 注入 | 需要 Root 权限运行 frida-server |
| 绕过 SSL Pinning | 需要修改系统证书存储或用 Frida |
| 查看应用私有数据 | `/data/data/` 目录需要 Root 才能访问 |
| Hook 系统 API | Xposed/LSPosed 需要 Root + Magisk |
| 抓取加密流量 | 安装系统级 CA 证书需要 Root |

---

## 四、为什么要刷真机而不是使用模拟器

PC 端有很多安卓模拟器（夜神、雷电、BlueStacks、Google 官方模拟器等），用起来确实方便，但在逆向场景下**容易被 App 检测识别**，很多情况下不如真机可靠。

### 1. App 如何检测模拟器

#### 硬件/设备信息

| 检测项 | 真机 | 模拟器 |
|--------|------|--------|
| `Build.MODEL` | 具体型号如 "cepheus" | "sdk_gphone_x86_64"、"Google Pixel" 等通用值 |
| `Build.BRAND` | "xiaomi"、"samsung" | "google"、"generic" |
| `Build.HARDWARE` | "qcom" 等真实芯片 | "ranchu"、"goldfish" |
| `Build.FINGERPRINT` | 真实设备指纹 | 包含 "generic"、"test-keys" 等关键词 |
| CPU 架构 | ARM（arm64-v8a） | x86 / x86_64（大部分模拟器） |
| 传感器 | 加速度计、陀螺仪等完整 | 缺失或数据异常（永远返回固定值） |
| 电池信息 | 正常充放电 | 永远满电或无电池 |
| 蓝牙/GPS | 有真实硬件 | 缺失或虚拟 |

#### 文件系统特征

模拟器会在系统中留下特征文件，App 只要检测到就知道你在用模拟器：

```
/dev/qemu_pipe              # QEMU 模拟器管道
/dev/goldfish_pipe          # Goldfish 内核特征
/system/bin/nox-prop        # 夜神模拟器
/system/bin/microvirt       # 逍遥模拟器
/system/lib/libdroid4x.so  # 海马玩
```

#### 其他检测手段

- **电话相关**：模拟器的 IMEI 通常是全0或固定值，没有真实基带信息
- **OpenGL 渲染器**：模拟器通常返回 "Swiftshader"、"Android Emulator" 等
- **IP/网络**：模拟器的网络环境与真机不同
- **性能特征**：x86 转译 ARM 指令存在可被检测的性能差异

### 2. 各模拟器隐蔽性对比

从容易被检测到相对难检测：

```
容易被检测 ←————————————————————→ 相对难检测

夜神/雷电/逍遥     BlueStacks     Google 官方模拟器     真机
(大量特征文件)      (中等)        (较干净但仍是x86)    (最佳)
```

**没有任何模拟器能完美模拟真机**，因为 CPU 架构（x86 vs ARM）这个根本差异很难伪装。

### 3. 模拟器在不同场景下的可用性

| 场景 | 模拟器可用性 | 说明 |
|------|-------------|------|
| 普通 App 抓包分析 | 完全够用 | 大部分普通 App 不检测模拟器 |
| 静态分析 + 简单动态调试 | 够用 | 基础逆向练习没问题 |
| 银行/金融 App | 基本不行 | 检测非常严格 |
| 主流手游（王者、吃鸡等） | 不行 | 反作弊系统会检测 |
| 有壳/有反调试的 App | 看情况 | 很多壳会检测模拟器 |

### 4. 实际建议

- **入门练手阶段**：模拟器完全可以用，方便快捷，不怕搞坏
- **正式逆向目标 App**：用真机（Root 后的真机是最好的工具）
- **理想方案**：两个都准备着，简单的用模拟器快速测试，遇到检测就切真机

模拟器最大的优势是**方便**——快照、多开、不怕变砖，作为练习环境非常好。但真机才是逆向工程师的主力装备。

---

## 五、补充建议

小米9 社区支持非常好，Root 之后还可以考虑刷类原生 ROM（如 LineageOS、PixelExperience 等），因为：

- MIUI 有很多自带限制和后台行为，会干扰逆向分析
- 类原生系统更干净，更方便做安全研究

---

## 六、Hook 技术与外挂应用

### 1. 什么是 Hook？

Hook（钩子）是一种拦截并修改程序运行时行为的技术。通俗地说，就是在程序调用某个函数时，**半路拦截**，用你自己的逻辑替换或修改原本的行为，然后再（可选地）放行原函数继续执行。

```
正常流程：  游戏代码 → 调用系统函数 → 返回结果
Hook 后：   游戏代码 → 调用系统函数 → [被拦截] → 你的代码修改结果 → 返回篡改后的结果
```

Hook 是 Android 逆向和外挂实现的**核心技术**，几乎所有外挂本质上都是在 Hook。

---

### 2. 变速器（变速齿轮）

#### 背景

"变速齿轮"原本是一款 PC 端的经典变速工具，只能用于 Windows 游戏。但**"变速"这个技术思路是跨平台通用的**，在 Android 上同样可以实现。

#### 原理

游戏中的"时间"并非物理时间，而是通过调用系统 API 获取的时间值。变速的本质就是 **Hook 时间函数，让返回值以 N 倍速度增长**，游戏读到的"时间"变快了，游戏逻辑自然就加速了。

#### Android 上常见的时间源

| 时间函数 | 层级 | 说明 |
|----------|------|------|
| `System.currentTimeMillis()` | Java 层 | 获取当前时间戳（毫秒） |
| `SystemClock.uptimeMillis()` | Java 层 | 系统启动后经过的时间 |
| `clock_gettime()` | Native 层（C/C++） | C/C++ 游戏常用 |
| `gettimeofday()` | Native 层（C/C++） | 获取当前时间 |

变速工具会同时 Hook 多个时间源，确保全面覆盖。

#### 各平台的变速工具对比

| 平台 | 工具 | Hook 的目标函数 |
|------|------|-----------------|
| PC（Windows） | 变速齿轮、Cheat Engine 的 Speedhack | `QueryPerformanceCounter`、`GetTickCount` 等 Win API |
| Android | GameGuardian（GG修改器）、Frida | `clock_gettime`、`gettimeofday`、`System.currentTimeMillis()` 等 |
| iOS | iGameGuardian、Frida | 同 Android，Hook 系统时间函数 |

#### Frida 实现变速示例（Java 层）

```javascript
// 让时间流逝速度变为 2 倍
var startReal = Date.now();
var speed = 2.0;

Java.use("java.lang.System").currentTimeMillis.implementation = function() {
    var elapsed = Date.now() - startReal;
    return startReal + Math.floor(elapsed * speed);
};
```

实际使用中需要同时 Hook Native 层的时间函数才能对 C/C++ 游戏生效。

#### 变速的局限性

| 情况 | 说明 |
|------|------|
| 纯单机离线游戏 | 效果最好，时间逻辑全在本地 |
| 联网游戏 | 服务器有自己的时钟，会做时间校验，客户端加速会导致不同步、被检测 |
| 帧驱动型游戏 | 游戏逻辑绑定帧率而非时间函数，Hook 时间函数无效 |
| 反作弊检测 | 很多游戏会检测时间一致性（对比多个时间源），发现异常会封号 |

---

### 3. 常见的 Hook 外挂类型

除了变速之外，Hook 技术还可以实现以下常见外挂功能：

| 外挂类型 | Hook 目标 | 效果 |
|----------|-----------|------|
| **变速** | 时间函数 | 加速/减速游戏 |
| **内存修改** | 直接修改内存中的数值 | 无限金币、无限血量等 |
| **透视/自瞄** | 渲染函数、坐标数据 | 看到隐藏的敌人、自动瞄准 |
| **协议篡改** | 网络发包/收包函数 | 修改客户端发送给服务器的数据 |
| **去广告** | 广告 SDK 的加载函数 | 拦截广告展示 |
| **破解内购** | 支付验证函数 | 绕过付费验证 |

---

### 4. Android 上主要的 Hook 框架

| 框架 | 特点 | 适用场景 |
|------|------|----------|
| **Frida** | 动态注入，支持 Java 和 Native 层，脚本用 JavaScript 编写，灵活强大 | 逆向分析、动态调试、编写自定义外挂逻辑 |
| **Xposed / LSPosed** | 模块化框架，通过编写模块实现 Hook，需要 Root + Magisk | 持久化的系统级修改，如去广告、修改系统行为 |
| **GameGuardian（GG修改器）** | 图形界面，自带变速和内存搜索修改功能，需要 Root | 游戏内存修改、变速，门槛较低 |
| **Substrate / Cydia** | 较老的 Hook 框架 | 早期 Android/iOS 逆向 |

对于初学者，建议从 **Frida** 入手，它是目前最主流、最灵活的动态分析工具。
