# 安卓系统文件结构详解

## 一、系统分区概览

Android 设备的存储被划分为多个分区，每个分区承担不同职责：

| 分区 | 挂载点 | 说明 |
|------|--------|------|
| boot | - | 包含内核(kernel)和 ramdisk，引导系统启动 |
| recovery | - | 恢复模式分区，用于 OTA 升级和出厂重置 |
| system | `/system` | 存放 Android 操作系统核心文件 |
| vendor | `/vendor` | 厂商专有驱动和库文件 |
| userdata | `/data` | 用户数据分区，存放应用数据和用户文件 |
| cache | `/cache` | 系统缓存分区，存放 OTA 升级包等临时文件 |
| persist | `/persist` | 存放出厂校准数据、DRM 等持久化数据 |
| metadata | `/metadata` | 加密元数据分区 |
| dtbo | - | 设备树覆盖(Device Tree Blob Overlay) |
| vbmeta | - | Verified Boot 校验元数据 |

> **逆向关注点**：`system`、`vendor`、`data` 是逆向分析中最常接触的分区。

---

## 二、根目录结构 (`/`)

```
/
├── system/          # 系统核心文件
├── vendor/          # 厂商驱动/库
├── data/            # 用户数据
├── cache/           # 缓存
├── dev/             # 设备节点文件
├── proc/            # 内核进程信息（虚拟文件系统）
├── sys/             # 内核设备/驱动信息（虚拟文件系统）
├── mnt/             # 挂载点（SD卡等）
├── storage/         # 用户可见的存储目录
├── acct/            # cgroup 进程统计
├── config/          # 系统配置
├── init              # init 进程二进制文件
├── init.rc           # init 启动脚本
├── default.prop      # 默认系统属性
├── sepolicy          # SELinux 策略文件
└── ...
```

---

## 三、`/system` 目录详解（系统核心）

这是 Android 系统最核心的目录，出厂时预装的所有系统组件都在这里。

```
/system/
├── app/                 # 系统预装应用（可卸载）
│   └── Chrome/
│       └── Chrome.apk
├── priv-app/            # 特权系统应用（不可卸载，拥有更高权限）
│   ├── Settings/
│   ├── SystemUI/
│   ├── Launcher3/
│   └── TeleService/
├── framework/           # Android 框架核心 JAR 包
│   ├── framework.jar        # 核心框架类
│   ├── services.jar          # 系统服务
│   ├── ext.jar               # 扩展库
│   ├── core-libart.jar       # ART 运行时核心库
│   └── boot-framework.oat   # 预编译的 OAT 文件
├── lib/                 # 32位系统原生共享库 (.so)
│   ├── libc.so
│   ├── libm.so
│   ├── liblog.so
│   └── ...
├── lib64/               # 64位系统原生共享库 (.so)
├── bin/                 # 系统可执行程序
│   ├── app_process       # Zygote 进程启动器
│   ├── surfaceflinger    # 图形合成服务
│   ├── servicemanager    # Binder 服务管理器
│   ├── logcat            # 日志工具
│   └── sh                # shell
├── xbin/                # 扩展可执行程序（su 等）
├── etc/                 # 系统配置文件
│   ├── permissions/      # 权限白名单 XML
│   ├── init/             # init 服务定义
│   ├── security/         # CA 证书等安全配置
│   └── hosts             # hosts 文件
├── fonts/               # 系统字体
├── media/               # 开机动画、系统铃声
│   ├── bootanimation.zip
│   └── audio/
├── usr/                 # 用户级配置
│   ├── keylayout/        # 按键映射
│   └── icu/              # 国际化数据
└── build.prop           # ★ 系统构建属性文件（重要！）
```

### 关键文件说明

- **`build.prop`**：记录设备型号、Android 版本、API 级别、指纹等，逆向中常被修改用于伪装设备信息。
- **`framework/framework.jar`**：Android 框架的核心实现，Xposed/LSPosed 等框架的 Hook 目标。
- **`priv-app/`**：特权应用拥有 `signatureOrSystem` 级别权限，是逆向分析的重点。

---

## 四、`/vendor` 目录详解（厂商专有）

```
/vendor/
├── app/                 # 厂商预装应用
├── bin/                 # 厂商可执行文件（HAL 进程等）
├── lib/                 # 厂商32位 .so 库
├── lib64/               # 厂商64位 .so 库
├── etc/                 # 厂商配置文件
├── firmware/            # 固件文件（WiFi、蓝牙、GPU等）
├── overlay/             # 资源覆盖层
└── build.prop           # 厂商构建属性
```

> 从 Android 8.0 (Project Treble) 开始，`/vendor` 与 `/system` 严格分离，便于系统升级。

---

## 五、`/data` 目录详解（用户数据）

这是逆向分析中**最重要的目录**，存放所有应用的运行时数据。

```
/data/
├── app/                         # 用户安装的 APK 文件
│   └── com.example.app-1/
│       ├── base.apk             # APK 本体
│       ├── lib/                 # 原生库
│       └── oat/                 # 编译后的 OAT/ODEX
├── data/                        # ★ 应用私有数据目录
│   └── com.example.app/
│       ├── shared_prefs/        # SharedPreferences XML 文件
│       ├── databases/           # SQLite 数据库
│       ├── files/               # 应用内部文件
│       ├── cache/               # 应用缓存
│       ├── code_cache/          # JIT/AOT 编译缓存
│       ├── lib/                 # 私有 .so 库 (符号链接)
│       └── no_backup/           # 不参与备份的文件
├── user/                        # 多用户数据（符号链接到 data/）
├── user_de/                     # 设备加密的用户数据
├── system/                      # 系统级数据
│   ├── packages.xml             # ★ 已安装应用信息注册表
│   ├── packages.list            # 应用包名-UID 映射
│   ├── appops.xml               # 应用操作权限记录
│   └── users/                   # 用户账户信息
├── misc/                        # 杂项数据
│   ├── wifi/                    # WiFi 配置
│   ├── adb/                     # ADB RSA 密钥
│   └── profiles/                # ART 配置文件
├── local/                       # 本地临时数据
│   └── tmp/
├── dalvik-cache/                # Dalvik/ART 缓存
│   └── arm64/
├── property/                    # 系统属性持久化
└── media/                       # 用户媒体文件
    └── 0/                       # 即内部存储（/sdcard）
        ├── DCIM/
        ├── Download/
        ├── Pictures/
        ├── Android/
        │   ├── data/            # 应用外部数据（公开可访问）
        │   └── obb/             # 应用扩展文件
        └── ...
```

### 逆向常用路径

| 路径 | 用途 |
|------|------|
| `/data/data/<pkg>/shared_prefs/` | 应用配置、登录状态、Token |
| `/data/data/<pkg>/databases/` | 本地数据库，可能含敏感数据 |
| `/data/data/<pkg>/files/` | 应用写入的文件 |
| `/data/app/<pkg>/base.apk` | 已安装的 APK（可提取分析） |
| `/data/system/packages.xml` | 查看应用权限、签名信息 |

---

## 六、其他重要目录

### `/proc`（虚拟文件系统）
```
/proc/
├── cpuinfo          # CPU 信息
├── meminfo          # 内存信息
├── mounts           # 当前挂载信息
├── version          # 内核版本
├── <pid>/           # 每个进程的信息
│   ├── maps         # ★ 内存映射（逆向调试关键）
│   ├── status       # 进程状态
│   ├── cmdline      # 启动命令行
│   ├── fd/          # 文件描述符
│   └── mem          # 进程内存
└── ...
```

> **逆向关键**：`/proc/<pid>/maps` 可查看进程的内存布局，定位 .so 加载基址，是动态调试的基础。

### `/dev`（设备节点）
```
/dev/
├── null             # 空设备
├── zero             # 零设备
├── random           # 随机数设备
├── binder           # ★ Binder IPC 设备节点
├── ashmem           # 匿名共享内存
├── input/           # 输入设备
│   └── event*       # 触摸/按键事件
├── block/           # 块设备（存储分区）
└── ...
```

### `/mnt` 和 `/storage`
```
/mnt/
├── sdcard/          # 内部存储挂载点
└── media_rw/        # 可写媒体

/storage/
├── emulated/0/      # 内部存储（即 /sdcard）
└── XXXX-XXXX/       # 外部 SD 卡（按UUID命名）
```

---

## 七、APK 文件内部结构

了解 APK 内部结构是逆向分析的基础：

```
example.apk (本质是 ZIP 压缩包)
├── AndroidManifest.xml      # ★ 应用清单（二进制XML）
├── classes.dex              # ★ Dalvik 字节码（主要逆向目标）
├── classes2.dex             # 多 DEX（MultiDex）
├── resources.arsc           # 编译后的资源索引表
├── res/                     # 资源文件
│   ├── layout/              # 布局 XML
│   ├── drawable-*/          # 图片资源
│   ├── values/              # 字符串、颜色等
│   └── ...
├── lib/                     # 原生 .so 库
│   ├── armeabi-v7a/         # 32位 ARM
│   ├── arm64-v8a/           # 64位 ARM
│   ├── x86/                 # x86
│   └── x86_64/              # x86_64
├── assets/                  # 原始资源文件
├── META-INF/                # 签名信息
│   ├── MANIFEST.MF          # 清单摘要
│   ├── CERT.SF              # 签名文件
│   └── CERT.RSA             # 证书
└── kotlin/                  # Kotlin 元数据（如果使用 Kotlin）
```

### 逆向工具对应

| 文件 | 分析工具 |
|------|----------|
| `classes.dex` | jadx、jeb、baksmali、dex2jar |
| `AndroidManifest.xml` | aapt2、apktool、jadx |
| `lib/*.so` | IDA Pro、Ghidra、radare2 |
| `resources.arsc` | apktool |
| 整体 APK | apktool (反编译/回编译) |

---

## 八、Android 启动流程与文件关系

```
BootLoader
    ↓
boot 分区 → Linux Kernel 加载
    ↓
init 进程 (/init)
    ↓ 解析 init.rc
挂载文件系统 (system, vendor, data...)
    ↓
启动核心服务 (servicemanager, surfaceflinger...)
    ↓
Zygote 进程 (/system/bin/app_process)
    ↓ 加载 framework.jar
System Server (AMS, PMS, WMS...)
    ↓
Launcher 启动 → 用户界面
```

---

## 九、逆向分析常用 ADB 命令速查

```bash
# 查看分区挂载情况
adb shell mount

# 查看系统属性
adb shell getprop

# 提取已安装 APK
adb shell pm path com.example.app
adb pull /data/app/com.example.app-1/base.apk

# 查看应用数据目录（需 root）
adb shell su -c "ls /data/data/com.example.app/"

# 查看进程内存映射
adb shell su -c "cat /proc/<pid>/maps"

# 查看已安装应用列表
adb shell pm list packages

# 查看应用权限
adb shell dumpsys package com.example.app | grep permission

# 查看系统文件结构
adb shell ls -la /system/
```

---

## 十、权限与安全相关

| 机制 | 说明 |
|------|------|
| Linux UID/GID | 每个应用分配唯一 UID，实现沙箱隔离 |
| SELinux | 强制访问控制，限制进程权限（`/sepolicy`） |
| dm-verity | 验证 system/vendor 分区完整性 |
| Verified Boot | 启动链校验，防止分区被篡改 |
| 文件权限 | `/data/data/<pkg>/` 目录默认仅应用自身可访问 |

> **Root 的本质**：获取 UID 0（root）的权限，绕过 Linux 权限控制和 SELinux 限制，从而可以访问任意文件和执行任意操作。

---

*文档创建日期：2026-02-22*
